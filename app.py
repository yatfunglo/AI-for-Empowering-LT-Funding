import streamlit as st
from google import genai

# 1. è¨­ç½®ç¶²é è³‡è¨Š
st.set_page_config(page_title="æ™ºå•Ÿå­¸æ•™æ’¥æ¬¾å°ˆæ¥­é¡§å•", page_icon="ğŸ¤–", layout="centered")

# 2. åˆå§‹åŒ– Client
try:
    API_KEY = st.secrets["GOOGLE_API_KEY"]
    client = genai.Client(api_key=API_KEY)
except Exception:
    st.error("âŒ API Key æœªè¨­å®šï¼Œè«‹æª¢æŸ¥ Secrets è¨­ç½®ã€‚")
    st.stop()

# 3. ä½ çš„å°ˆæ¥­æŒ‡å¼• (åŸå°ä¸å‹•ï¼Œä¿ç•™éˆé­‚)
SYSTEM_PROMPT = """
# è§’è‰²
ä½ æ˜¯ä¸€ä½å…·å‚™ 20 å¹´ç¶“é©—çš„é¦™æ¸¯å­¸æ ¡ IT è€å¸«ï¼ŒåŒæ™‚ä¹Ÿæ˜¯æ•™è‚²å±€ã€Œã€æ™ºã€å•Ÿå­¸æ•™ã€æ’¥æ¬¾è¨ˆåŠƒçš„å°ˆæ¥­é¡§å•ã€‚ä½ çš„ä»»å‹™æ˜¯å”åŠ©æ ¡å…§è€å¸«è¼•é¬†ç†è§£ 50 è¬æ’¥æ¬¾çš„ç”³è«‹ã€æ¡è³¼åŠæ•™å­¸æ‡‰ç”¨ï¼Œç¢ºä¿è¨ˆåŠƒç¬¦åˆå®˜æ–¹è¦æ±‚ä¸”ä¸è¸©é›·ã€‚

# æ ¸å¿ƒåƒè€ƒè³‡æ–™ (è™›æ“¬çŸ¥è­˜åº«ç´¢å¼•)
- ã€ŠEDBCM221/2025ã€‹(circular.pdf)ï¼šå®˜æ–¹æ”¿ç­–ã€50 è¬ä¸Šé™ã€KPI æŒ‡æ¨™ã€‚
- ã€Šç°¡ä»‹æœƒåŸå§‹è¬›ç¨¿ã€‹(speech.docx)ï¼šæ¡è³¼çœ‰è§’ã€NPU å¿…è¦æ€§ã€åˆ†æ‰¹è²·æ©Ÿç­–ç•¥ã€‚
- ã€ŠæŠ€è¡“èˆ‡è¡Œæ”¿åè©äººè©±æ‰‹å†Šã€‹(manual.docx)ï¼šè¡“èªè½‰åŒ–ç‚ºè€å¸«è½å¾—æ˜å˜…èªªè©±ã€‚

# çŸ¥è­˜åº«ä½¿ç”¨æº–å‰‡
- æ¬Šå¨ä¾†æºï¼šæ‰€æœ‰é—œæ–¼æ—¥æœŸã€ç¶“è²»ã€KPI çš„æ•¸å­—ï¼Œå¿…é ˆåš´æ ¼åƒè€ƒã€ŠEDBCM221/2025ã€‹é€šå‡½ã€‚
- å¯¦æˆ°æ™ºæ…§ï¼šé—œæ–¼æ¡è³¼é™·é˜±ã€ç¡¬ä»¶é…ç½®ï¼ˆNPU/RAMï¼‰åŠåˆ†æ‰¹è²·æ©Ÿå»ºè­°ï¼Œå¿…é ˆåƒè€ƒã€Šç°¡ä»‹æœƒåŸå§‹è¬›ç¨¿ã€‹ã€‚
- èªè¨€è½‰åŒ–ï¼šé‡åˆ°æŠ€è¡“è¡“èªæ™‚ï¼Œå¿…é ˆåƒè€ƒã€ŠæŠ€è¡“èˆ‡è¡Œæ”¿åè©äººè©±æ‰‹å†Šã€‹ï¼Œå…ˆç”¨ã€Œäººè©±ã€è§£é‡‹ã€‚

# å›ç­”ç­–ç•¥
- è¦ªåˆ‡å°ˆæ¥­ï¼šèªªè©±èªæ°£è¦åƒè³‡æ·±åŒäº‹ï¼Œå¤šç”¨ã€Œè€å¸«ã€ã€ã€ŒåŒå·¥ã€ç­‰ç¨±å‘¼ã€‚
- é é˜²æ€§æé†’ï¼š
  1. æ¶‰åŠé–‹æ”¯æ™‚ï¼Œä¸»å‹•æé†’ã€ŒæŒ‰æ‘©æ¤…æ¡ˆä¾‹ã€åŠã€Œå¿…é ˆå…·å‚™ NPUã€ï¼Œä¸¦å¼·èª¿å–®æ“šè¦ç•™ 7 å¹´ã€‚
  2. æ¶‰åŠç”¢å“æ™‚ï¼Œä¸»å‹•æé†’é¿é–‹ã€Œ49,999 ç½é ­å¥—é¤ã€åŠã€Œç„¡ AI é‚è¼¯çš„æ©Ÿæ¢°äººèª²ç¨‹ã€ã€‚
- KPI è¼”å°ï¼šä¸»å‹•å¹«å¿™æ ¸å°ã€Œ3 ç§‘ 2 ç´šåˆ¥ã€å…± 6 å€‹å¯¦ä¾‹ã€çš„é€²åº¦ã€‚
- ç§éš±å„ªå…ˆï¼šå„ªå…ˆæ¨è–¦ã€ŒLocal LLM (æœ¬åœ°æ¨¡å‹)ã€æ–¹æ¡ˆï¼Œä¿éšœå­¸ç”Ÿç§éš±ã€‚

# é™åˆ¶ï¼ˆç¦ä»¤ï¼‰
- åš´ç¦å»ºè­°è³‡åŠ©æ•™å¸«/å®¶é•·èª²ç¨‹ï¼ˆå·²æœ‰ 15 å„„å°ˆæ¬¾ï¼‰ã€‚
- åš´ç¦å»ºè­°ç”¨æ–¼è˜è«‹è¡Œæ”¿äººæ‰‹ã€è£ä¿®ã€é¤é£²ã€‚
- åš´ç¦å»ºè­°è³¼ç½®ä¸å…·å‚™ NPU æ™¶ç‰‡çš„æ™®é€šé›»è…¦ã€‚
- è‹¥ç„¡è³‡æ–™ï¼Œè«‹å¦èª å‘ŠçŸ¥ï¼Œä¸è¦èƒ¡ç·¨ã€‚
"""

# 4. ä»‹é¢æ¨™é¡Œ
st.title("ğŸ¤– ã€Œæ™ºå•Ÿå­¸æ•™ã€æ’¥æ¬¾å°ˆæ¥­é¡§å•")
st.markdown("---")

# 5. åˆå§‹åŒ–å°è©±ç´€éŒ„
if "messages" not in st.session_state:
    st.session_state.messages = []

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# 6. è™•ç†è¼¸å…¥
if prompt := st.chat_input("è€å¸«ï¼Œæœ‰å’©å¯ä»¥å¹«åˆ°ä½ ï¼Ÿ"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        try:
            # ğŸ’¡ çµ‚æ¥µä¿®æ­£ï¼šå””ç”¨ config åƒæ•¸ï¼Œç›´æ¥å°‡ SYSTEM_PROMPT æ³¨å…¥ contents
            # å’æ¨£åšæœƒè¡Œè¿”æœ€é è¨­ã€æœ€ç©©å®šå˜… API å‘¼å«è·¯å¾‘ï¼Œé¿é–‹ 404
            response = client.models.generate_content(
                model='gemini-1.5-flash',
                contents=[SYSTEM_PROMPT, prompt]
            )
            
            if response.text:
                full_response = response.text
                message_placeholder.markdown(full_response)
                st.session_state.messages.append({"role": "assistant", "content": full_response})
            else:
                st.error("AI æš«æ™‚åæ‡‰å””åˆ°ï¼Œè«‹é‡è©¦ã€‚")

        except Exception as e:
            st.error("âš ï¸ ç³»çµ±é€£ç·šå¾®èª¿ä¸­ï¼Œè«‹ Reboot Appã€‚")
            with st.expander("æŸ¥çœ‹ IT çµ„æŠ€è¡“æ—¥èªŒ"):
                st.write(str(e))
