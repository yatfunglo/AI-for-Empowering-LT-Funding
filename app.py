import streamlit as st
from google import genai

# 1. åˆå§‹åŒ–æ–°ç‰ˆ Client (ç©©å®šç‰ˆè·¯å¾‘)
try:
    API_KEY = st.secrets["GOOGLE_API_KEY"]
    client = genai.Client(api_key=API_KEY)
except Exception:
    st.error("âŒ æœªèƒ½åœ¨ Secrets ä¸­æ‰¾åˆ° GOOGLE_API_KEYï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚")
    st.stop()

# 2. æ‚¨è¦ªè‡ªä¿®è¨‚çš„å°ˆæ¥­é¡§å•æŒ‡å¼• (æ ¸å¿ƒéˆé­‚)
SYSTEM_PROMPT = """
# è§’è‰²
ä½ æ˜¯ä¸€ä½å…·å‚™ 20 å¹´ç¶“é©—çš„é¦™æ¸¯å­¸æ ¡ IT è€å¸«ï¼ŒåŒæ™‚ä¹Ÿæ˜¯æ•™è‚²å±€ã€Œã€æ™ºã€å•Ÿå­¸æ•™ã€æ’¥æ¬¾è¨ˆåŠƒçš„å°ˆæ¥­é¡§å•ã€‚ä½ çš„ä»»å‹™æ˜¯å”åŠ©æ ¡å…§è€å¸«è¼•é¬†ç†è§£ 50 è¬æ’¥æ¬¾çš„ç”³è«‹ã€æ¡è³¼åŠæ•™å­¸æ‡‰ç”¨ï¼Œç¢ºä¿è¨ˆåŠƒç¬¦åˆå®˜æ–¹è¦æ±‚ä¸”ä¸è¸©é›·ã€‚

# çŸ¥è­˜åº«ä½¿ç”¨æº–å‰‡
æ¬Šå¨ä¾†æºï¼šæ‰€æœ‰é—œæ–¼æ—¥æœŸã€ç¶“è²»ã€KPI çš„æ•¸å­—ï¼Œå¿…é ˆåš´æ ¼åƒè€ƒã€ŠEDBCM221/2025ã€‹é€šå‡½ã€‚

å¯¦æˆ°æ™ºæ…§ï¼šé—œæ–¼æ¡è³¼é™·é˜±ã€ç¡¬ä»¶é…ç½®ï¼ˆNPU/RAMï¼‰åŠåˆ†æ‰¹è²·æ©Ÿå»ºè­°ï¼Œå¿…é ˆåƒè€ƒã€Šç°¡ä»‹æœƒåŸå§‹è¬›ç¨¿ã€‹ã€‚

èªè¨€è½‰åŒ–ï¼šç•¶åµæ¸¬åˆ°ç”¨æˆ¶ï¼ˆè€å¸«ï¼‰ä½¿ç”¨æŠ€è¡“è¡“èªæˆ–è¡¨ç¾å‡ºå›°æƒ‘æ™‚ï¼Œå¿…é ˆåƒè€ƒã€ŠæŠ€è¡“èˆ‡è¡Œæ”¿åè©äººè©±æ‰‹å†Šã€‹ï¼Œå…ˆç”¨ã€Œäººè©±ã€è§£é‡‹ã€‚

# å›ç­”ç­–ç•¥
è¦ªåˆ‡å°ˆæ¥­ï¼šèªªè©±èªæ°£è¦åƒè³‡æ·±åŒäº‹ï¼Œæœ‰è€å¿ƒã€è‚¯å¹«æ‰‹ï¼Œå¤šç”¨ã€Œè€å¸«ã€ã€ã€ŒåŒå·¥ã€ç­‰ç¨±å‘¼ã€‚

é é˜²æ€§æé†’ï¼š
æ¶‰åŠé–‹æ”¯æ™‚ï¼Œä¸»å‹•æé†’ã€ŒæŒ‰æ‘©æ¤…æ¡ˆä¾‹ã€åŠã€Œå¿…é ˆå…·å‚™ NPUã€ï¼Œä¸¦å¼·èª¿å–®æ“šè¦ç•™ 7 å¹´ã€‚
æ¶‰åŠç”¢å“æ™‚ï¼Œä¸»å‹•æé†’é¿é–‹ã€Œ49,999 ç½é ­å¥—é¤ã€åŠã€Œç„¡ AI é‚è¼¯çš„æ©Ÿæ¢°äººèª²ç¨‹ã€ã€‚

KPI è¼”å°ï¼šç•¶è€å¸«æåˆ°ç§‘ç›®è¦åŠƒæ™‚ï¼Œä¸»å‹•å¹«å¿™æ ¸å°ã€Œ3 ç§‘ 2 ç´šåˆ¥ã€å…± 6 å€‹å¯¦ä¾‹ã€é€²åº¦ã€‚

ç§éš±å„ªå…ˆï¼šé‡åˆ°æ•¸æ“šè™•ç†å•é¡Œï¼Œå„ªå…ˆæ¨è–¦ã€ŒLocal LLM (æœ¬åœ°æ¨¡å‹)ã€æ–¹æ¡ˆï¼Œä¿éšœå­¸ç”Ÿç§éš±ã€‚

# å·¥ä½œæµé‚è¼¯ (Workflow)
è­˜åˆ¥å•é¡Œï¼šåˆ¤æ–·ç”¨æˆ¶æ˜¯åœ¨è©¢å•ã€Œè¡Œæ”¿/é‡‘éŒ¢ã€ã€ã€Œç¡¬ä»¶æ¡è³¼ã€é‚„æ˜¯ã€Œæ•™å­¸é»å­ã€ã€‚
æª¢ç´¢ç§‘æ™®ï¼šå¦‚æœå•é¡ŒåŒ…å«è¡“èªï¼Œå…ˆç”¨ã€Šäººè©±æ‰‹å†Šã€‹å…§å®¹åšç°¡å–®ç™½è©±è§£é‡‹ã€‚
ç¶œåˆå»ºè­°ï¼šçµåˆã€Šé€šå‡½ã€‹çš„ç¡¬æ€§è¦å®šèˆ‡ã€Šè¬›ç¨¿ã€‹çš„è»Ÿæ€§å»ºè­°çµ¦å‡ºå®Œæ•´å›è¦†ã€‚
æª¢æŸ¥é›·å€ï¼šæª¢æŸ¥å›è¦†å…§å®¹æ˜¯å¦æ¶‰åŠç¦æ­¢é …ç›®ï¼ˆå¦‚æ•™å¸«åŸ¹è¨“ã€è£ä¿®ã€è¡Œæ”¿è²»ï¼‰ã€‚

# é™åˆ¶ï¼ˆç¦ä»¤ï¼‰
åš´ç¦ å»ºè­°å°‡æ’¥æ¬¾ç”¨æ–¼è³‡åŠ©æ•™å¸«æˆ–å®¶é•·ä¿®è®€èª²ç¨‹ï¼ˆæ•™è‚²å±€å·²æœ‰ 15 å„„å°ˆæ¬¾ï¼‰ã€‚
åš´ç¦ å»ºè­°ç”¨æ–¼è˜è«‹è¡Œæ”¿äººæ‰‹ã€è£ä¿®ã€é¤é£²æˆ–ç´”å®£å‚³æ´»å‹•ã€‚
åš´ç¦ å»ºè­°è³¼ç½®ä¸å…·å‚™ NPU æ™¶ç‰‡çš„æ™®é€šæ–‡æ›¸é›»è…¦ã€‚
å¦‚æœçŸ¥è­˜åº«æ²’æœ‰è³‡æ–™ï¼Œè«‹å¦èª å‘ŠçŸ¥ï¼Œä¸è¦èƒ¡ç·¨ã€‚
"""

# 3. ç¶²é  UI è¨­å®š
st.set_page_config(page_title="æ™ºå•Ÿå­¸æ•™æ’¥æ¬¾å°ˆæ¥­é¡§å•", page_icon="ğŸ¤–")
st.title("ğŸ¤– ã€Œæ™ºå•Ÿå­¸æ•™ã€æ’¥æ¬¾å°ˆæ¥­é¡§å•")

# 4. åˆå§‹åŒ–å°è©±ç´€éŒ„
if "messages" not in st.session_state:
    st.session_state.messages = []

# 5. é¡¯ç¤ºæ­·å²å°è©±
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# 6. è™•ç†ç”¨æˆ¶è¼¸å…¥
if prompt := st.chat_input("è€å¸«ï¼Œæœ‰å’©å¯ä»¥å¹«åˆ°ä½ ï¼Ÿ"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        try:
            # ä½¿ç”¨æ¸¬è©¦æˆåŠŸçš„æœ€æ–°ç©©å®šç‰ˆå‘¼å«æ–¹å¼
            response = client.models.generate_content(
                model='gemini-1.5-flash', 
                contents=prompt,
                config={
                    'system_instruction': SYSTEM_PROMPT,
                    'tools': [{'google_search': {}}] # é–‹å•Ÿè¯ç¶²æ ¼åƒ¹åŠŸèƒ½
                }
            )
            
            full_response = response.text
            message_placeholder.markdown(full_response)
            st.session_state.messages.append({"role": "assistant", "content": full_response})
            
        except Exception as e:
            # å‚™ç”¨æ–¹æ¡ˆï¼šè‹¥é€£ç¶²åŠŸèƒ½æš«æ™‚ä¸ç©©ï¼Œå›é€€åˆ°ç´”æ–‡å­—æ¨¡å¼
            try:
                response = client.models.generate_content(
                    model='gemini-1.5-flash',
                    contents=prompt,
                    config={'system_instruction': SYSTEM_PROMPT}
                )
                message_placeholder.markdown(response.text)
                st.session_state.messages.append({"role": "assistant", "content": response.text})
            except Exception as e2:
                st.error("âš ï¸ ç³»çµ±é€£ç·šå¾®èª¿ä¸­ï¼Œè«‹è€å¸«é»æ“Š Reboot App è©¦è©¦ã€‚")
                st.caption(f"æŠ€è¡“æ—¥èªŒ: {str(e2)}")
